<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crystal Field Splitter & CSA Powder Simulator</title>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#9ca3af;--text:#e6eef8;--accent:#60a5fa}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071023 0%,#081126 60%);color:var(--text)}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    h1{margin:0 0 6px;font-weight:700}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}
    .tab.active{background:linear-gradient(90deg,rgba(96,165,250,0.12),rgba(52,211,153,0.06));color:var(--text);border-color:rgba(96,165,250,0.18)}
    .card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);border-radius:12px;padding:16px}
    .layout{display:grid;grid-template-columns:320px 1fr;gap:16px}
    .panel{display:flex;flex-direction:column;gap:12px}
    .group{background:rgba(255,255,255,0.01);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.02)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=number], select, input[type=range]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}
    .diagram{background:linear-gradient(180deg,#010612,rgba(2,6,23,0.6));border-radius:10px;padding:12px;min-height:420px;display:flex;align-items:center;justify-content:center}
    svg, canvas{border-radius:8px}
    .footer{margin-top:10px;color:var(--muted);font-size:13px}
    .meta{display:flex;justify-content:space-between;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>Crystal Field Splitter & CSA Powder Simulator</h1>
    <p class="lead">Two drop-in tools for teaching and exploration — a compact <strong>Crystal Field</strong> energy-level visualizer and a static <strong>CSA powder</strong> simulator. Copy this single HTML file into your site.</p>

    <div class="tabs" role="tablist">
      <button class="tab active" data-target="cft" role="tab" aria-selected="true">Crystal Field Splitting</button>
      <button class="tab" data-target="csa" role="tab" aria-selected="false">CSA Powder Pattern</button>
    </div>

    <div class="card layout">
      <!-- Controls column -->
      <div class="panel">
        <!-- Crystal field controls -->
        <div class="group" id="cftControls">
          <div class="meta"><strong>Crystal Field</strong><span class="small">interactive diagram</span></div>
          <label for="geom">Geometry</label>
          <select id="geom" aria-label="Geometry">
            <option value="oh">Octahedral (Oₕ)</option>
            <option value="td">Tetrahedral (Tₗ)</option>
            <option value="sp">Square Planar (D₄h)</option>
          </select>

          <label for="delta">Δ (10Dq / overall splitting) <span class="small" id="deltaLabel">1.50 eV</span></label>
          <input id="delta" type="range" min="0" max="4" step="0.01" value="1.5">

          <label for="dcount">d-electrons (dⁿ)</label>
          <input id="dcount" type="number" min="0" max="10" value="6">

          <label for="spin">Spin state</label>
          <select id="spin"><option value="high">High spin</option><option value="low">Low spin</option></select>

          <label for="pair">Pairing energy P (eV)</label>
          <input id="pair" type="number" step="0.01" min="0" max="4" value="0.8">

          <div class="small">CFSE shown relative to the barycenter. Use the download button to save SVG.</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="resetCFT">Reset</button>
            <button class="btn" id="downloadCFT">Download SVG</button>
          </div>
        </div>

        <!-- CSA controls -->
        <div class="group" id="csaControls" style="display:none">
          <div class="meta"><strong>CSA Powder</strong><span class="small">static powder histogram</span></div>
          <label for="d11">δ₁₁ (ppm)</label>
          <input id="d11" type="number" step="0.1" value="200">
          <label for="d22">δ₂₂ (ppm)</label>
          <input id="d22" type="number" step="0.1" value="100">
          <label for="d33">δ₃₃ (ppm)</label>
          <input id="d33" type="number" step="0.1" value="-50">
          <label for="nsamp">Orientations (samples)</label>
          <input id="nsamp" type="number" min="500" max="200000" value="12000">
          <label for="bins">Histogram bins</label>
          <input id="bins" type="number" min="50" max="2000" value="400">
          <label for="fwhm">Gaussian broadening FWHM (ppm)</label>
          <input id="fwhm" type="number" step="0.1" value="1.0">
          <label for="pad">ppm padding</label>
          <input id="pad" type="number" step="1" value="20">
          <div class="row" style="margin-top:8px">
            <button class="btn" id="runCSA">Simulate</button>
            <button class="btn" id="downloadCSA">Download PNG</button>
          </div>
          <div class="small" style="margin-top:8px">Displays δ_iso, span Ω and skew κ (Haeberlen convention).</div>
        </div>

      </div>

      <!-- Visualization column -->
      <div class="diagram">
        <!-- Crystal field SVG -->
        <svg id="cftSVG" width="100%" height="420" viewBox="0 0 760 420" aria-label="Crystal field diagram"></svg>
        <!-- CSA canvas (hidden by default) -->
        <canvas id="csaCanvas" width="760" height="420" style="display:none"></canvas>
      </div>
    </div>

    <div class="footer">Want tweaks — e.g. include Tanabe–Sugano energy levels, simulate MAS sidebands, or add interactive 3D unit cell visuals? Tell me which and I’ll adapt the file.</div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const t = btn.dataset.target;
      document.getElementById('cftControls').style.display = t==='cft' ? '' : 'none';
      document.getElementById('csaControls').style.display = t==='csa' ? '' : 'none';
      document.getElementById('cftSVG').style.display = t==='cft' ? '' : 'none';
      document.getElementById('csaCanvas').style.display = t==='csa' ? '' : 'none';
    }));

    // --- Crystal field logic ---
    const geom = document.getElementById('geom');
    const delta = document.getElementById('delta');
    const deltaLabel = document.getElementById('deltaLabel');
    const dcount = document.getElementById('dcount');
    const spin = document.getElementById('spin');
    const pair = document.getElementById('pair');
    const cftSVG = document.getElementById('cftSVG');

    function getLevels(geometry, Delta){
      if(geometry==='oh'){
        return [ {label:'t₂g', g:3, E:-0.4*Delta}, {label:'e_g', g:2, E:0.6*Delta} ];
      } else if(geometry==='td'){
        const Dt = 4/9*Delta; return [ {label:'e', g:2, E:-0.6*Dt}, {label:'t₂', g:3, E:0.4*Dt} ];
      } else {
        const E = [-0.35,-0.15,0.05,0.45].map(x=>x*Delta);
        return [ {label:'d xz/yz', g:2, E:E[0]}, {label:'d z²', g:1, E:E[1]}, {label:'d xy', g:1, E:E[2]}, {label:'d x²−y²', g:1, E:E[3]} ];
      }
    }

    function fillElectrons(levels, n, spinState){
      const subs = [];
      levels.forEach(L=>{ for(let i=0;i<L.g;i++) subs.push({E:L.E,label:L.label,occ:0}); });
      subs.sort((a,b)=>a.E-b.E);
      let rem = n;
      if(spinState==='high'){
        // place one by one preferring lower energy and emptiest
        while(rem>0){ subs.sort((a,b)=> (a.occ-b.occ)||(a.E-b.E)); subs[0].occ++; rem--; }
      } else {
        for(const s of subs){ const add = Math.min(2, rem); s.occ+=add; rem-=add; if(rem<=0) break; }
      }
      let cfse=0, pairs=0, unpaired=0;
      for(const s of subs){ cfse += s.occ*s.E; if(s.occ===2) pairs++; else if(s.occ===1) unpaired++; }
      return {subs,cfse,pairs,unpaired};
    }

    function renderCFT(){
      const G = geom.value; const D = parseFloat(delta.value); deltaLabel.textContent = D.toFixed(2)+' eV';
      const n = parseInt(dcount.value)||0; const sp = spin.value; const P = parseFloat(pair.value)||0;
      const levels = getLevels(G,D); const filled = fillElectrons(levels,n,sp);
      // draw
      const W=760,H=420; cftSVG.innerHTML='';
      const midX = W/2; const len = 320; const yScale = 120;
      // barycenter line
      const zero = document.createElementNS('http://www.w3.org/2000/svg','line'); zero.setAttribute('x1',midX-len/2-10); zero.setAttribute('x2',midX+len/2+10); zero.setAttribute('y1',H/2); zero.setAttribute('y2',H/2); zero.setAttribute('stroke','#263144'); zero.setAttribute('stroke-dasharray','6 4'); cftSVG.appendChild(zero);
      // group by label
      const groups = {};
      filled.subs.forEach(s=>{ groups[s.label]=groups[s.label]||[]; groups[s.label].push(s); });
      const uniq = Object.keys(groups).map(k=>({label:k,E:groups[k][0].E,arr:groups[k]})).sort((a,b)=>a.E-b.E);
      uniq.forEach((g,i)=>{
        const y = H/2 - g.E*yScale;
        const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',midX-len/2); line.setAttribute('x2',midX+len/2); line.setAttribute('y1',y); line.setAttribute('y2',y); line.setAttribute('stroke','#475569'); line.setAttribute('stroke-width','3'); cftSVG.appendChild(line);
        const txt = document.createElementNS('http://www.w3.org/2000/svg','text'); txt.setAttribute('x',midX-len/2-12); txt.setAttribute('y',y-8); txt.setAttribute('fill','#cbd5e1'); txt.setAttribute('font-size','13'); txt.setAttribute('text-anchor','end'); txt.textContent = g.label; cftSVG.appendChild(txt);
        const nsub = g.arr.length; const spacing = (len-80)/Math.max(1,nsub-1); const start = midX-len/2+40;
        g.arr.forEach((s,idx)=>{
          const x = start + idx*spacing;
          const stick = document.createElementNS('http://www.w3.org/2000/svg','line'); stick.setAttribute('x1',x); stick.setAttribute('x2',x); stick.setAttribute('y1',y-16); stick.setAttribute('y2',y+16); stick.setAttribute('stroke','#1f2a36'); stick.setAttribute('stroke-width','2'); cftSVG.appendChild(stick);
          const r=6; if(s.occ>=1){ const e1 = document.createElementNS('http://www.w3.org/2000/svg','circle'); e1.setAttribute('cx',x); e1.setAttribute('cy',y-7); e1.setAttribute('r',r); e1.setAttribute('fill','#60a5fa'); cftSVG.appendChild(e1); }
          if(s.occ>=2){ const e2 = document.createElementNS('http://www.w3.org/2000/svg','circle'); e2.setAttribute('cx',x); e2.setAttribute('cy',y+7); e2.setAttribute('r',r); e2.setAttribute('fill','#34d399'); cftSVG.appendChild(e2); }
        });
      });
      // info overlay
      const info = document.createElementNS('http://www.w3.org/2000/svg','text'); info.setAttribute('x',20); info.setAttribute('y',20); info.setAttribute('fill','#9fb1c9'); info.setAttribute('font-size','13'); info.textContent = `dⁿ=${n}, spin=${sp}, CFSE=${filled.cfse.toFixed(3)} eV, pairs=${filled.pairs}, unpaired=${filled.unpaired}`; cftSVG.appendChild(info);
    }

    document.getElementById('resetCFT').addEventListener('click',()=>{ geom.value='oh'; delta.value=1.5; dcount.value=6; spin.value='high'; pair.value=0.8; renderCFT(); });
    document.getElementById('downloadCFT').addEventListener('click',()=>{
      const s = new XMLSerializer().serializeToString(cftSVG); const blob = new Blob([s],{type:'image/svg+xml'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='crystal_field.svg'; a.click(); URL.revokeObjectURL(url);
    });
    [geom,delta,dcount,spin,pair].forEach(el=>el.addEventListener('input',renderCFT));
    renderCFT();

    // --- CSA powder ---
    const d11 = document.getElementById('d11'); const d22 = document.getElementById('d22'); const d33 = document.getElementById('d33');
    const nsamp = document.getElementById('nsamp'); const bins = document.getElementById('bins'); const fwhm = document.getElementById('fwhm'); const pad = document.getElementById('pad');
    const runCSA = document.getElementById('runCSA'); const downloadCSA = document.getElementById('downloadCSA');
    const canvas = document.getElementById('csaCanvas'); const ctx = canvas.getContext('2d');

    function randOrient(){ let u,v,s; do{u=Math.random()*2-1; v=Math.random()*2-1; s=u*u+v*v;} while(s>=1||s===0); const mul=2*Math.sqrt(1-s); return [u*mul, v*mul, 1-2*s]; }

    function simulateCSA(){
      const D=[parseFloat(d11.value), parseFloat(d22.value), parseFloat(d33.value)]; const N=Math.max(500,Math.min(200000,parseInt(nsamp.value)||12000)); const B=Math.max(50,Math.min(2000,parseInt(bins.value)||400));
      const vals = new Float64Array(N);
      for(let i=0;i<N;i++){ const n = randOrient(); vals[i] = D[0]*n[0]*n[0] + D[1]*n[1]*n[1] + D[2]*n[2]*n[2]; }
      const min = Math.min(...vals), max = Math.max(...vals);
      const diso = (D[0]+D[1]+D[2])/3; const sorted = D.slice().sort((a,b)=>b-a); const Omega = sorted[0]-sorted[2]; const kappa = Omega!==0 ? 3*(sorted[1]-diso)/Omega : 0;
      // histogram
      const padppm = parseFloat(pad.value)||0; const lo = min-padppm; const hi = max+padppm; const dx = (hi-lo)/B; const hist = new Float64Array(B);
      for(let i=0;i<N;i++){ const idx = Math.max(0,Math.min(B-1, Math.floor((vals[i]-lo)/dx))); hist[idx] += 1; }
      // gaussian smooth
      const f = Math.max(0,parseFloat(fwhm.value)||0); let y = hist;
      if(f>0){ const sigma=f/2.355; const krad=Math.max(2, Math.ceil(4*sigma/dx)); const ksize=2*krad+1; const g=new Float64Array(ksize);
        for(let k=-krad;k<=krad;k++) g[k+krad] = Math.exp(-0.5*Math.pow(k*dx/sigma,2)); const sum = g.reduce((a,b)=>a+b,0); for(let i=0;i<ksize;i++) g[i]/=sum;
        const conv = new Float64Array(B);
        for(let i=0;i<B;i++){ let acc=0; for(let k=-krad;k<=krad;k++){ const j=i+k; if(j>=0&&j<B) acc += y[j]*g[k+krad]; } conv[i]=acc; }
        y = conv;
      }
      drawCSA(lo,hi,y,diso,Omega,kappa);
    }

    function drawCSA(lo,hi,y,diso,Omega,kappa){ const W=canvas.width, H=canvas.height; ctx.clearRect(0,0,W,H); ctx.fillStyle='#9fb1c9'; ctx.font='12px Inter,Arial';
      // axes
      ctx.strokeStyle='#2b3a4a'; ctx.lineWidth=1.5; ctx.beginPath(); ctx.moveTo(50, H-40); ctx.lineTo(W-20, H-40); ctx.stroke(); ctx.beginPath(); ctx.moveTo(50,20); ctx.lineTo(50, H-40); ctx.stroke();
      ctx.fillText(`δ_iso=${diso.toFixed(2)} ppm  Ω=${Omega.toFixed(2)} ppm  κ=${kappa.toFixed(3)}`, 56, 34);
      const B = y.length; const maxY = Math.max(...y) || 1;
      ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2; ctx.beginPath();
      for(let i=0;i<B;i++){ const x = 50 + i*(W-70)/(B-1); const v = y[i]/maxY; const yy = (H-40) - v*(H-80); if(i===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy); }
      ctx.stroke(); ctx.fillStyle='#64748b'; ctx.textAlign='center';
      const nt=6; for(let t=0;t<=nt;t++){ const x = 50 + t*(W-70)/nt; const ppm = lo + t*(hi-lo)/nt; ctx.fillText(ppm.toFixed(0), x, H-18); }
    }

    runCSA.addEventListener('click', simulateCSA);
    downloadCSA.addEventListener('click', ()=>{ const a=document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download='csa_powder.png'; a.click(); });
    // initial draw on load
    simulateCSA();
  </script>
</body>
</html>
